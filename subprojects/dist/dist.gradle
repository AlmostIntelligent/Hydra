configurations.all {
    artifacts.clear()
}

tasks.remove(jar)
tasks.remove(test)

tasks.withType(AbstractArchiveTask) {
    baseName "hydra"
    destinationDir = rootProject.distsDir
    clean.delete archivePath
}

dependencies {
    testCompile(":actors")
    testCompile(":core")
    testCompile(":launcher")
}

configurations {
    dists
}

evaluationDependsOn ':launcher'

ext {
    distRootFolder = "hydra-$version"

    modulesImage = copySpec {
        rootProject.configurations.runtime.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            from (artifact.file) {
                target = artifact.moduleVersion.id.group.replace(".", "/");
                name = artifact.name.replace("javax", "").replace(".", "")
                into ("modules/system/layers/base/${target}/${name}/main")
            }
        }
    }

    binDistImage = copySpec {
        from ('src/main/resources') {
            include '*/**'
        }
        from (rootProject.configurations.modules) {
            rename '(.*).jar', 'jboss-modules.jar'
        }
        with (modulesImage)
    }
}

task dist(type: Copy, dependsOn: ':launcher:assemble') {
    destinationDir = rootProject.buildDir
    into(distRootFolder) {
        with binDistImage
    }
}

task binZip(type: Zip, dependsOn: 'dist') {
    classifier = 'bin'
    into(distRootFolder) {
        with binDistImage
    }
}

artifacts {
    dists binZip
}